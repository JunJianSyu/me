---
title: "GamepadKeyMapper"
date: "2026-01-30"
category: "æŠ€æœ¯"
tags: ["Go", "Xbox"]
excerpt: "GamepadKeyMapperè¯¦è§£"
featured: true
---

# ä»£ç æ¶æ„ä¸é€»è¾‘æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ GamepadKeyMapper çš„ä»£ç æ¶æ„ã€æ¨¡å—è®¾è®¡å’Œæ ¸å¿ƒé€»è¾‘ã€‚

## ç›®å½•ç»“æ„

```
/
â”œâ”€â”€ main.go                 # ç¨‹åºå…¥å£
â”œâ”€â”€ go.mod / go.sum         # Goæ¨¡å—å®šä¹‰
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ app/                # åº”ç”¨æ§åˆ¶å±‚
â”‚   â”‚   â””â”€â”€ app.go
â”‚   â”œâ”€â”€ config/             # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ config.go
â”‚   â”‚   â””â”€â”€ storage.go
â”‚   â”œâ”€â”€ gamepad/            # æ‰‹æŸ„è¾“å…¥å±‚
â”‚   â”‚   â”œâ”€â”€ buttons.go
â”‚   â”‚   â”œâ”€â”€ listener.go
â”‚   â”‚   â”œâ”€â”€ xinput.go
â”‚   â”‚   â”œâ”€â”€ xinput_windows.go
â”‚   â”‚   â””â”€â”€ xinput_stub.go
â”‚   â”œâ”€â”€ keyboard/           # é”®ç›˜æ¨¡æ‹Ÿå±‚
â”‚   â”‚   â”œâ”€â”€ keys.go
â”‚   â”‚   â”œâ”€â”€ simulator_windows.go
â”‚   â”‚   â””â”€â”€ simulator_stub.go
â”‚   â”œâ”€â”€ mapper/             # æ˜ å°„å¼•æ“
â”‚   â”‚   â”œâ”€â”€ mapper.go
â”‚   â”‚   â””â”€â”€ rule.go
â”‚   â””â”€â”€ ui/                 # ç”¨æˆ·ç•Œé¢
â”‚       â”œâ”€â”€ window.go
â”‚       â”œâ”€â”€ tray.go
â”‚       â”œâ”€â”€ mapping_list.go
â”‚       â””â”€â”€ mapping_form.go
â””â”€â”€ assets/                 # é™æ€èµ„æº
```

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UI Layer (Fyne)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Main Window â”‚  â”‚ System Tray â”‚  â”‚ Mapping Form/List   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                    â”‚
          â–¼                â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    App Controller (app.go)                  â”‚
â”‚  â€¢ ç”Ÿå‘½å‘¨æœŸç®¡ç† (Start/Stop)                                  â”‚
â”‚  â€¢ è§„åˆ™ç®¡ç†(Add/Remove/Get)                                  â”‚
â”‚  â€¢ é…ç½®æŒä¹…åŒ– (Load/Save)                                     â”‚
â”‚  â€¢ çŠ¶æ€å›è°ƒé€šçŸ¥                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                â”‚                    â”‚
          â–¼                â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Core Layer                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Gamepad    â”‚  â”‚   Mapper     â”‚  â”‚    Keyboard      â”‚   â”‚
â”‚  â”‚   Listener   â”‚â”€â–¶â”‚   Engine     â”‚â”€â–¶â”‚    Simulator     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â€¢ XInputè½®è¯¢      â€¢ è§„åˆ™åŒ¹é…         â€¢ SendInput API         â”‚
â”‚  â€¢ äº‹ä»¶æ£€æµ‹        â€¢ å¾ªç¯ä¿æŠ¤         â€¢ æŒ‰é”®çŠ¶æ€è¿½è¸ª             â”‚
â”‚  â€¢ çŠ¶æ€å˜åŒ–é€šçŸ¥    â€¢ é“¾å¼è§¦å‘         â€¢ ç»„åˆé”®æ”¯æŒ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                     â”‚
          â–¼                                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Platform Layer (Windows)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  xinput1_4.dll       â”‚    â”‚  user32.dll              â”‚   â”‚
â”‚  â”‚  â€¢ XInputGetState    â”‚    â”‚  â€¢ SendInput             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ¨¡å—è¯¦è§£

### 1. æ‰‹æŸ„è¾“å…¥å±‚ (internal/gamepad)

#### buttons.go - æŒ‰é”®å®šä¹‰

å®šä¹‰æ‰€æœ‰æ”¯æŒçš„æ‰‹æŸ„æŒ‰é”®å¸¸é‡ï¼š

```go
type Button uint32

const (
    ButtonA       Button = 0x1000   // æ ‡å‡†XInputæŒ‰é”®ä½
    ButtonLT      Button = 0x10000  // æ‰³æœºï¼ˆç‰¹æ®Šå¤„ç†ï¼‰
    ButtonPaddle1 Button = 0x40000  // ç²¾è‹±ç‰ˆæ‹¨ç‰‡
    ButtonLeftStickUp Button = 0x400000  // æ‘‡æ†æ–¹å‘ï¼ˆè™šæ‹Ÿï¼‰
)
```

**æŒ‰é”®åˆ†ç±»**:
- **æ ‡å‡†æŒ‰é”®** (0x0001-0x8000): ç›´æ¥å¯¹åº” XInput Buttons ä½æ©ç 
- **æ‰³æœºæŒ‰é”®** (0x10000-0x20000): æ¨¡æ‹Ÿé‡è½¬æ•°å­—ï¼Œä½¿ç”¨é˜ˆå€¼åˆ¤æ–­
- **ç²¾è‹±æ‹¨ç‰‡** (0x40000-0x200000): æ‰©å±•æŒ‰é”®
- **æ‘‡æ†æ–¹å‘** (0x400000+): è™šæ‹ŸæŒ‰é”®ï¼Œæ‘‡æ†ä½ç½®è½¬æ–¹å‘

#### xinput.go / xinput_windows.go - XInputå°è£…

**XInputçŠ¶æ€ç»“æ„**:
```go
type XInputState struct {
    PacketNumber uint32      // çŠ¶æ€åŒ…åºå·
    Gamepad      XInputGamepad
}

type XInputGamepad struct {
    Buttons      uint16   // æŒ‰é”®ä½æ©ç 
    LeftTrigger  uint8    // å·¦æ‰³æœº (0-255)
    RightTrigger uint8    // å³æ‰³æœº (0-255)
    ThumbLX      int16    // å·¦æ‘‡æ†X (-32768~32767)
    ThumbLY      int16    // å·¦æ‘‡æ†Y
    ThumbRX      int16    // å³æ‘‡æ†X
    ThumbRY      int16    // å³æ‘‡æ†Y
}
```

**DLLåŠ è½½é€»è¾‘**:
```go
func LoadXInput() error {
    // æŒ‰ç‰ˆæœ¬é¡ºåºå°è¯•åŠ è½½
    dllNames := []string{
        "xinput1_4.dll",   // Windows 8.1+
        "xinput1_3.dll",   // Windows 7
        "xinput9_1_0.dll", // Windows Vista
    }
    // ...
}
```

#### listener.go - äº‹ä»¶ç›‘å¬å™¨

**è½®è¯¢æœºåˆ¶**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              pollLoop (100Hz)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚  â”‚ ticker  â”‚â”€â”€â”€ 10ms â”€â”€â”€â–¶ poll()        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚       â”‚                                 â”‚
â”‚       â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ poll()                           â”‚   â”‚
â”‚  â”‚  â”œâ”€ GetState(controllerID)       â”‚   â”‚
â”‚  â”‚  â”œâ”€ pollButtons() æ£€æµ‹æŒ‰é”®å˜åŒ–    â”‚    â”‚
â”‚  â”‚  â”œâ”€ pollTriggers() æ£€æµ‹æ‰³æœºå˜åŒ–   â”‚    â”‚
â”‚  â”‚  â””â”€ pollSticks() æ£€æµ‹æ‘‡æ†æ–¹å‘     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚                                 â”‚
â”‚       â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ sendEvent(button, pressed)       â”‚   â”‚
â”‚  â”‚  â””â”€ eventChan <- ButtonEvent     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€å˜åŒ–æ£€æµ‹ç®—æ³•**:
```go
// æŒ‰é”®æ£€æµ‹ - ä½¿ç”¨å¼‚æˆ–æ‰¾å‡ºå˜åŒ–çš„ä½
changed := currentButtons ^ prevState
if changed&btnMask != 0 {
    pressed := currentButtons&btnMask != 0
    sendEvent(btn, pressed)
}

// æ‰³æœºæ£€æµ‹ - ä½¿ç”¨é˜ˆå€¼
currentLT := state.Gamepad.LeftTrigger > TriggerThreshold // 128
if currentLT != prevLT {
    sendEvent(ButtonLT, currentLT)
}

// æ‘‡æ†æ–¹å‘æ£€æµ‹ - ä½¿ç”¨é˜ˆå€¼
leftUp := state.Gamepad.ThumbLY > StickThreshold // 16384 (~50%)
```

### 2. é”®ç›˜æ¨¡æ‹Ÿå±‚ (internal/keyboard)

#### keys.go - é”®ç›˜æŒ‰é”®å®šä¹‰

```go
type KeyCode int

// Windows Virtual Key Codes
const (
    KeyF1    KeyCode = 0x70
    KeyA     KeyCode = 0x41
    KeySpace KeyCode = 0x20
)

type Modifiers struct {
    Ctrl  bool
    Alt   bool
    Shift bool
    Win   bool
}
```

#### simulator_windows.go - é”®ç›˜æ¨¡æ‹Ÿå™¨

**æ ¸å¿ƒæ•°æ®ç»“æ„**:
```go
type Simulator struct {
    mu           sync.Mutex
    pressedKeys  map[KeyCode]bool  // å½“å‰æŒ‰ä½çš„é”®
    pressedMods  Modifiers         // å½“å‰æŒ‰ä½çš„ä¿®é¥°é”®
}
```

**æŒ‰é”®ä¿æŒæœºåˆ¶**:
```
PressKeys(keys, mods):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥ä¿®é¥°é”®æ˜¯å¦å·²æŒ‰ä¸‹               â”‚
â”‚    â””â”€ æœªæŒ‰ä¸‹åˆ™å‘é€æŒ‰ä¸‹äº‹ä»¶            â”‚
â”‚ 2. æ£€æŸ¥ç›®æ ‡é”®æ˜¯å¦å·²æŒ‰ä¸‹               â”‚
â”‚    â””â”€ æœªæŒ‰ä¸‹åˆ™å‘é€æŒ‰ä¸‹äº‹ä»¶            â”‚
â”‚ 3. æ›´æ–° pressedKeys/pressedMods    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ReleaseKeys(keys, mods):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥ç›®æ ‡é”®æ˜¯å¦æŒ‰ä½                 â”‚
â”‚    â””â”€ æŒ‰ä½åˆ™å‘é€é‡Šæ”¾äº‹ä»¶              â”‚
â”‚ 2. æ£€æŸ¥ä¿®é¥°é”®æ˜¯å¦éœ€è¦é‡Šæ”¾              â”‚
â”‚    â””â”€ éœ€è¦åˆ™å‘é€é‡Šæ”¾äº‹ä»¶              â”‚
â”‚ 3. ä» pressedKeys/pressedMods ç§»é™¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**SendInputè°ƒç”¨**:
```go
type INPUT struct {
    Type uint32        // INPUT_KEYBOARD = 1
    Ki   KEYBDINPUT
}

type KEYBDINPUT struct {
    Vk        uint16   // Virtual Key Code
    Scan      uint16   // æ‰«æç 
    Flags     uint32   // KEYEVENTF_KEYUP, KEYEVENTF_EXTENDEDKEY
    Time      uint32
    ExtraInfo uintptr
}

// è°ƒç”¨ user32.dll SendInput
ret, _, _ := procSendInput.Call(
    uintptr(len(inputs)),
    uintptr(unsafe.Pointer(&inputs[0])),
    uintptr(unsafe.Sizeof(INPUT{})),
)
```

### 3. æ˜ å°„å¼•æ“ (internal/mapper)

#### rule.go - æ˜ å°„è§„åˆ™

```go
type TargetType int

const (
    TargetKeyboard TargetType = iota  // ç›®æ ‡æ˜¯é”®ç›˜
    TargetGamepad                      // ç›®æ ‡æ˜¯æ‰‹æŸ„æŒ‰é”®
)

type MappingRule struct {
    ID            string
    SourceKey     gamepad.Button
    TargetType    TargetType
    
    // é”®ç›˜ç›®æ ‡
    TargetKeys    []keyboard.KeyCode
    Modifiers     keyboard.Modifiers
    
    // æ‰‹æŸ„ç›®æ ‡
    TargetButtons []gamepad.Button
    
    Enabled       bool
}
```

#### mapper.go - æ˜ å°„å¼•æ“æ ¸å¿ƒ

**äº‹ä»¶å¤„ç†æµç¨‹**:
```
HandleEvent(event):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å¾ªç¯ä¿æŠ¤æ£€æŸ¥                                        â”‚
â”‚    if processing[event.Button] â†’ return              â”‚
â”‚                                                      â”‚
â”‚ 2. æŸ¥æ‰¾åŒ¹é…è§„åˆ™                                        â”‚
â”‚    for rule in rules:                                â”‚
â”‚        if rule.SourceKey == event.Button             â”‚
â”‚                                                      â”‚
â”‚ 3. æ ¹æ®ç›®æ ‡ç±»å‹å¤„ç†                                     â”‚
â”‚    â”œâ”€ TargetKeyboard:                                â”‚
â”‚    â”‚   if pressed: PressKeys()                       â”‚
â”‚    â”‚   else: ReleaseKeys()                           â”‚
â”‚    â”‚                                                 â”‚
â”‚    â””â”€ TargetGamepad:                                 â”‚
â”‚        handleGamepadMapping()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ‰‹æŸ„æ˜ å°„é€’å½’å¤„ç†**:
```
handleGamepadMapping(rule, pressed):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ ‡è®°æºæŒ‰é”®æ­£åœ¨å¤„ç† (å¾ªç¯ä¿æŠ¤)                          â”‚
â”‚    processing[rule.SourceKey] = true                 â”‚
â”‚                                                      â”‚
â”‚ 2. éå†ç›®æ ‡æ‰‹æŸ„æŒ‰é”®                                     â”‚
â”‚    for targetBtn in rule.TargetButtons:              â”‚
â”‚                                                      â”‚
â”‚ 3. æŸ¥æ‰¾ç›®æ ‡æŒ‰é”®çš„æ˜ å°„è§„åˆ™                                â”‚
â”‚    for targetRule in rules:                          â”‚
â”‚        if targetRule.SourceKey == targetBtn          â”‚
â”‚                                                      â”‚
â”‚ 4. æ‰§è¡Œç›®æ ‡è§„åˆ™                                        â”‚
â”‚    â”œâ”€ TargetKeyboard: PressKeys/ReleaseKeys          â”‚
â”‚    â””â”€ TargetGamepad: é€’å½’ handleGamepadMapping        â”‚
â”‚       (æœ‰å¾ªç¯ä¿æŠ¤ï¼Œä¸ä¼šæ— é™é€’å½’)                         â”‚
â”‚                                                      â”‚
â”‚ 5. æ¸…é™¤å¤„ç†æ ‡è®°                                        â”‚
â”‚    delete(processing, rule.SourceKey)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¾ªç¯ä¿æŠ¤æœºåˆ¶**:
```
é…ç½®: A â†’ B, B â†’ A

æ‰§è¡Œ: æŒ‰ä¸‹A
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HandleEvent(A pressed)              â”‚
â”‚   processing[A] = true              â”‚
â”‚   â†’ æŸ¥æ‰¾Açš„è§„åˆ™: A â†’ B                â”‚
â”‚   â†’ handleGamepadMapping for B      â”‚
â”‚       processing[B] = true          â”‚
â”‚       â†’ æŸ¥æ‰¾Bçš„è§„åˆ™: B â†’ A            â”‚
â”‚       â†’ æ£€æŸ¥ processing[A] = true    â”‚
â”‚       â†’ è·³è¿‡ (é˜²æ­¢å¾ªç¯)               â”‚
â”‚       processing[B] = false         â”‚
â”‚   processing[A] = false             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. åº”ç”¨æ§åˆ¶å±‚ (internal/app)

#### app.go - åº”ç”¨æ§åˆ¶å™¨

**çŠ¶æ€ç®¡ç†**:
```go
type State int

const (
    StateStopped State = iota
    StateRunning
)

type App struct {
    mapper   *mapper.Mapper
    listener *gamepad.Listener
    state    State
    mu       sync.RWMutex
    
    // å›è°ƒ
    onStateChange func(State)
    onRulesChange func()
    onError       func(error)
}
```

**å¯åŠ¨æµç¨‹**:
```
Start():
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥æ˜¯å¦å·²è¿è¡Œ                     â”‚
â”‚ 2. å¯åŠ¨æ‰‹æŸ„ç›‘å¬å™¨                     â”‚
â”‚    listener.Start()                 â”‚
â”‚ 3. å¯åŠ¨äº‹ä»¶å¤„ç†åç¨‹                    â”‚
â”‚    go eventLoop()                   â”‚
â”‚ 4. æ›´æ–°çŠ¶æ€ä¸º Running                 â”‚
â”‚ 5. è§¦å‘çŠ¶æ€å˜æ›´å›è°ƒ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åœæ­¢æµç¨‹**:
```
Stop():
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ£€æŸ¥æ˜¯å¦å·²åœæ­¢                      â”‚
â”‚ 2. é‡Šæ”¾æ‰€æœ‰æŒ‰ä½çš„é”®                    â”‚
â”‚    mapper.ReleaseAll()              â”‚
â”‚ 3. åœæ­¢æ‰‹æŸ„ç›‘å¬å™¨                     â”‚ 
â”‚    listener.Stop()                  â”‚
â”‚ 4. æ›´æ–°çŠ¶æ€ä¸º Stopped                 â”‚
â”‚ 5. è§¦å‘çŠ¶æ€å˜æ›´å›è°ƒ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº‹ä»¶å¾ªç¯**:
```go
func (a *App) eventLoop() {
    for event := range a.listener.Events() {
        a.mapper.HandleEvent(event)
    }
    // é€šé“å…³é—­åè‡ªåŠ¨é€€å‡º
}
```

### 5. é…ç½®ç®¡ç† (internal/config)

#### config.go - é…ç½®ç»“æ„

```go
type Config struct {
    Rules          []*mapper.MappingRule
    MinimizeToTray bool
    StartMinimized bool
}
```

#### storage.go - æŒä¹…åŒ–

**é…ç½®è·¯å¾„**:
```go
func GetConfigPath() (string, error) {
    // ä¼˜å…ˆ: %APPDATA%\GamepadKeyMapper\
    configDir, _ := os.UserConfigDir()
    appDir := filepath.Join(configDir, "GamepadKeyMapper")
    return filepath.Join(appDir, "gamepad-key-mapper.json"), nil
}
```

**åŠ è½½/ä¿å­˜**:
```go
// åŠ è½½ - å®¹é”™å¤„ç†
func Load() (*Config, error) {
    data, err := os.ReadFile(path)
    if os.IsNotExist(err) {
        return NewDefault(), nil  // è¿”å›é»˜è®¤é…ç½®
    }
    
    if json.Unmarshal(data, &cfg) != nil {
        os.Rename(path, path+".backup")  // å¤‡ä»½æŸåæ–‡ä»¶
        return NewDefault(), nil
    }
    return &cfg, nil
}

// ä¿å­˜
func Save(cfg *Config) error {
    data, _ := json.MarshalIndent(cfg, "", "  ")
    return os.WriteFile(path, data, 0644)
}
```

### 6. ç”¨æˆ·ç•Œé¢ (internal/ui)

#### window.go - ä¸»çª—å£

**å¸ƒå±€ç»“æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çŠ¶æ€: å·²åœæ­¢  â”‚  [å¯åŠ¨]  [åœæ­¢]          â”‚ â† æ§åˆ¶æ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŒ‰é”®æ˜ å°„åˆ—è¡¨                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ A â†’ âŒ¨ï¸ Ctrl+F1            [åˆ é™¤]   â”‚ â”‚
â”‚ â”‚ RB â†’ ğŸ® X+B               [åˆ é™¤]   â”‚ â”‚
â”‚ â”‚ ...                                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            [æ·»åŠ æ˜ å°„]                    â”‚ â† æ“ä½œæ 
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### tray.go - ç³»ç»Ÿæ‰˜ç›˜

**æ‰˜ç›˜èœå•ç»“æ„**:
```
å³é”®èœå•:
â”œâ”€ å¯åŠ¨
â”œâ”€ åœæ­¢
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€
â”œâ”€ æ˜¾ç¤ºçª—å£
â”œâ”€ â”€â”€â”€â”€â”€â”€â”€â”€
â””â”€ é€€å‡º
```

**çª—å£å…³é—­è¡Œä¸º**:
```go
func (t *Tray) SetupWindowClose() {
    t.window.SetCloseIntercept(func() {
        t.window.Hide()  // éšè—è€Œä¸æ˜¯å…³é—­
    })
}
```

## æ•°æ®æµ

### å®Œæ•´äº‹ä»¶æµ

```
[æ‰‹æŸ„æŒ‰ä¸‹LB]
    â”‚
    â–¼
XInput DLL (xinput1_4.dll)
    â”‚ XInputGetState()
    â–¼
Listener.poll()
    â”‚ æ£€æµ‹åˆ° Buttons å˜åŒ–
    â–¼
Listener.sendEvent(ButtonLB, true)
    â”‚ eventChan <- ButtonEvent
    â–¼
App.eventLoop()
    â”‚ for event := range events
    â–¼
Mapper.HandleEvent(event)
    â”‚ æŸ¥æ‰¾è§„åˆ™: LB â†’ Ctrl+F1
    â–¼
Simulator.PressKeys([F1], {Ctrl:true})
    â”‚ SendInput()
    â–¼
[ç³»ç»Ÿæ”¶åˆ° Ctrl+F1 æŒ‰é”®]
```

### é“¾å¼æ˜ å°„æµ

```
é…ç½®:
  RT â†’ ğŸ® A+B (æ‰‹æŸ„æ˜ å°„)
  A  â†’ âŒ¨ï¸ F1  (é”®ç›˜æ˜ å°„)
  B  â†’ âŒ¨ï¸ F2  (é”®ç›˜æ˜ å°„)

æ‰§è¡Œ:
[æŒ‰ä¸‹RT]
    â”‚
    â–¼
HandleEvent(RT, pressed)
    â”‚ è§„åˆ™: RT â†’ æ‰‹æŸ„ A+B
    â–¼
handleGamepadMapping()
    â”‚
    â”œâ”€â”€â–¶ æŸ¥æ‰¾Açš„è§„åˆ™ â†’ é”®ç›˜ F1
    â”‚    â””â”€ PressKeys([F1])
    â”‚
    â””â”€â”€â–¶ æŸ¥æ‰¾Bçš„è§„åˆ™ â†’ é”®ç›˜ F2
         â””â”€ PressKeys([F2])
    â”‚
    â–¼
[F1å’ŒF2åŒæ—¶è¢«æŒ‰ä¸‹]
```

## çº¿ç¨‹å®‰å…¨

### é”ä½¿ç”¨

| ç»„ä»¶ | é”ç±»å‹ | ä¿æŠ¤å¯¹è±¡ |
|------|--------|----------|
| Mapper.mu | RWMutex | rules åˆ—è¡¨ |
| Mapper.processingMu | Mutex | processing map |
| Simulator.mu | Mutex | pressedKeys, pressedMods |
| Listener.mu | Mutex | running, cancel |
| App.mu | RWMutex | state |

### å¹¶å‘æ¨¡å‹

```
Main Goroutine (UI)
    â”‚
    â”œâ”€â”€â–¶ App.Start() â”€â”€â–¶ Listener Goroutine (è½®è¯¢)
    â”‚                        â”‚
    â”‚                        â””â”€â”€â–¶ eventChan
    â”‚                                â”‚
    â””â”€â”€â–¶ App.eventLoop() â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â””â”€â”€â–¶ Mapper.HandleEvent()
                        â”‚
                        â””â”€â”€â–¶ Simulator (SendInput)
```

## é”™è¯¯å¤„ç†

### ä¼˜é›…é™çº§

1. **XInput åŠ è½½å¤±è´¥**: å°è¯•å¤šä¸ªDLLç‰ˆæœ¬
2. **æ‰‹æŸ„æœªè¿æ¥**: é™é»˜å¿½ç•¥ï¼Œç»§ç»­è½®è¯¢
3. **é…ç½®æ–‡ä»¶æŸå**: å¤‡ä»½åä½¿ç”¨é»˜è®¤é…ç½®
4. **äº‹ä»¶é€šé“æ»¡**: ä¸¢å¼ƒäº‹ä»¶ï¼Œä¸é˜»å¡

### çŠ¶æ€æ¢å¤

- **åœæ­¢æ—¶é‡Šæ”¾æŒ‰é”®**: `mapper.ReleaseAll()` ç¡®ä¿ä¸ä¼šå¡é”®
- **é‡å¯æ—¶é‡ç½®çŠ¶æ€**: `listener.Start()` é‡ç½®æ‰€æœ‰çŠ¶æ€å˜é‡

